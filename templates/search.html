{% extends "base.html" %}
{% block title %}Search — InventoryIQ{% endblock %}

{% block content %}

<style>
  /* ===== Scoped search UI (sx-*) ===== */
  .sx-wrap{max-width:var(--container);margin:0 auto;padding:22px}
  .sx-head {
  display: flex;
  align-items: center;  /* keeps arrow + text perfectly aligned */
  gap: 12px;
  margin: 0 0 14px;
}
  .sx-title{margin:0;font-size:36px;line-height:1.1}
  .sx-sub{margin:6px 0 0;color:var(--muted);font-size:13px}
  .sx-back {
  display: grid;
  place-items: center;    /* centers the arrow inside */
  width: 42px;
  height: 42px;
  border-radius: 12px;    /* rounded button */
  border: 1px solid var(--hairline);
  background: #fff;
  color: var(--ink);
  flex-shrink: 0;         /* prevents squishing */
  transition: 0.15s;
}
.bd-back:hover {
  transform: translateX(-2px);
  border-color: #dcdde0;
  background: #fafafa;
}

  .sx-chip{
    display:inline-flex;align-items:center;gap:6px;
    padding:6px 12px;border:1px solid var(--hairline);border-radius:999px;
    background:#fff;color:var(--muted);font-weight:700;font-size:13px;line-height:1;
    transform:translateY(4px); /* baseline nudge */
  }

  .sx-panel{background:#fff;border:1px solid var(--hairline);border-radius:14px;box-shadow:var(--shadow)}
  .sx-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}

  .sx-search{position:relative;flex:1 1 520px;max-width:820px}
  .sx-search input{width:100%;padding:10px 12px 10px 38px;border:1px solid var(--hairline);border-radius:12px;background:#fff}
  .sx-search svg{position:absolute;left:10px;top:50%;transform:translateY(-50%);width:18px;height:18px;color:#7a7f84}

  .sx-btn{padding:10px 14px;border-radius:10px;border:1px solid var(--hairline);background:#fff;font-weight:600;cursor:pointer}
  .sx-btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
  .sx-btn.primary:hover{background:var(--accent-700)}
  .sx-btn.ghost{background:#fff}
  .sx-btn.danger{color:var(--danger);border-color:var(--danger)}
  .sx-btn.small{padding:8px 10px;border-radius:8px}

  .sx-toolbar{display:flex;align-items:center;gap:10px;margin:12px 0 14px;background:#fff;border:1px solid var(--hairline);border-radius:12px;padding:10px 12px}
  .sx-flex{flex:1}
  .sx-sort{min-width:170px;padding:8px 10px;border:1px solid var(--hairline);border-radius:10px;background:#fff}
  .sx-view{display:flex;gap:6px}
  .sx-toggle{border:1px solid var(--hairline);border-radius:8px;padding:8px 10px;background:#fff}
  .sx-toggle[aria-pressed="true"]{border-color:#000}

  .sx-adv{display:none;margin:8px 0 0}
  .sx-adv.show{display:block}
  .sx-adv .sx-row{padding:10px 12px;background:#fff;border:1px solid var(--hairline);border-radius:12px}
  .sx-check{display:flex;align-items:center;gap:8px}
  .sx-select{padding:8px 10px;border:1px solid var(--hairline);border-radius:10px;background:#fff}

  .sx-grid{display:grid;grid-template-columns:repeat(12,1fr);gap:22px}
  .sx-col{grid-column:span 4}
  @media (max-width:1100px){.sx-col{grid-column:span 6}}
  @media (max-width:680px){.sx-col{grid-column:span 12}}

  .sx-card{background:#fff;border:1px solid var(--hairline);border-radius:16px;box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column;transition:.16s}
  .sx-card:hover{transform:translateY(-3px);box-shadow:0 14px 28px rgba(0,0,0,.08);border-color:#e2e2e4}
  .sx-media{margin:0;aspect-ratio:4/3;background:#f3f4f6}
  .sx-media img{width:100%;height:100%;object-fit:cover;display:block;cursor:zoom-in}
  .sx-pad{padding:14px 16px 16px}
  .sx-title-sm{margin:0 0 6px;font-weight:800;letter-spacing:.2px;font-size:18px}
  .sx-meta{color:var(--muted);font-size:12px}
  .sx-row-between{display:flex;align-items:center;justify-content:space-between;gap:12px}
  .chip{display:inline-block;padding:3px 8px;border:1px solid var(--hairline);border-radius:999px;font-size:12px;color:var(--muted)}

  .sx-progress{height:6px;border-radius:6px;background:#f0f1f2;overflow:hidden}
  .sx-progress > i{display:block;height:100%;background:linear-gradient(90deg,#1fb655,#47c266,#7fd081);width:0%}

  .sx-list .sx-col{grid-column:span 12}
  .sx-list .sx-card{flex-direction:row}
  .sx-list .sx-media{flex:0 0 180px;aspect-ratio:auto;height:120px}
  .sx-list .sx-pad{flex:1}

  .sx-empty{display:none;margin-top:12px}
  .sx-empty.show{display:block}

  .sx-hl{background:#ffef8a;padding:0 .15em;border-radius:.2em}

  /* Modal preview */
  .sx-modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:1200}
  .sx-modal.is-open{display:flex}
  .sx-modal img{max-width:92vw;max-height:92vh;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,.35)}
</style>

<div class="sx-wrap">

  <!-- Header -->
  <div class="sx-head">
    <a class="back-btn" href="{{ request.referrer or url_for('boxes.index') }}" aria-label="Back">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M15 18l-6-6 6-6"/>
    </svg>
  </a>
    <div>
      <h1 class="sx-title">Search <span id="sxCount" class="sx-chip" style="margin-left:8px">0 results</span></h1>
      <p class="sx-sub">Find items across all boxes.</p>
    </div>
  </div>

  <!-- Search form -->
  <div class="sx-panel" style="margin-bottom:12px">
    <div class="body">
      <form id="serverSearch" class="sx-row" method="post" action="{{ url_for('search.search') }}">
        <div class="sx-search">
          <input id="q" type="text" name="q" value="{{ q }}" placeholder="e.g., drill, extension cable, chargers…" autocomplete="off" />
          <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </div>
        <button class="sx-btn primary" type="submit">Search</button>
        <a class="sx-btn ghost" href="{{ url_for('search.search') }}">Clear</a>
        <button id="toggleAdv" class="sx-btn ghost" type="button" aria-expanded="false">Filters</button>
        <button id="exportCsv" class="sx-btn ghost" type="button" title="Export visible results">Export CSV</button>
        <div class="sx-flex"></div>
        <div class="sx-view" role="group" aria-label="View">
          <button class="sx-toggle" type="button" id="viewGrid" aria-pressed="true">Grid</button>
          <button class="sx-toggle" type="button" id="viewList" aria-pressed="false">List</button>
        </div>
      </form>

      <!-- Advanced filters -->
      <div id="adv" class="sx-adv">
        <div class="sx-row">
          <label class="sx-check"><input type="checkbox" id="fWithPhoto"> With photo</label>
          <label class="sx-check"><input type="checkbox" id="fPriced"> Priced only</label>
          <label>Confidence ≥
            <input id="fConf" type="number" step="0.05" min="0" max="1" value="0" style="width:90px" />
          </label>
          <label>Price $
            <input id="fMin" type="number" step="0.01" min="0" placeholder="min" style="width:100px" />
            —
            <input id="fMax" type="number" step="0.01" min="0" placeholder="max" style="width:100px" />
          </label>
          <label>Box
            <select id="fBox" class="sx-select">
              <option value="">Any</option>
              {# unique box list computed in JS too; SSR fallback here #}
              {% if results %}
                {% for g in results|groupby('box_name') %}
                  <option value="{{ g.grouper|e }}">{{ g.grouper }}</option>
                {% endfor %}
              {% endif %}
            </select>
          </label>
        </div>
      </div>
    </div>
  </div>

  <!-- Results toolbar -->
  <div class="sx-toolbar">
    <div class="sx-flex"></div>
    <label for="sortBy" class="visually-hidden">Sort by</label>
    <select id="sortBy" class="sx-sort">
      <option value="relevance">Relevance</option>
      <option value="name_asc">Name A→Z</option>
      <option value="name_desc">Name Z→A</option>
      <option value="price_asc">Price low→high</option>
      <option value="price_desc">Price high→low</option>
      <option value="conf_desc">Confidence high→low</option>
      <option value="conf_asc">Confidence low→high</option>
      <option value="date_desc">Newest</option>
      <option value="date_asc">Oldest</option>
    </select>
  </div>

  <!-- Results -->
  <section id="results" class="sx-grid" aria-live="polite">
    {# SSR fallback (no JS) #}
    {% if results %}
      {% for r in results %}
        <a class="sx-card sx-col" href="{{ url_for('boxes.box_detail', box_id=r.box_id) }}" style="text-decoration:none;">
          <figure class="sx-media">
            {% if r.image_url %}
              <img src="{{ r.image_url }}" alt="{{ r.item_name }}" loading="lazy" decoding="async" data-zoom>
            {% else %}
              <img src="https://source.unsplash.com/1200x675/?{{ r.item_name|urlencode }},object" alt="{{ r.item_name }}" loading="lazy" decoding="async" data-zoom>
            {% endif %}
          </figure>
          <div class="sx-pad">
            <div class="sx-row-between" style="margin-bottom:4px">
              <h3 class="sx-title-sm">{{ r.item_name }}</h3>
              <span class="chip">Conf {{ '%.2f'|format(r.confidence or 0) }}</span>
            </div>
            <div class="sx-progress" aria-hidden="true"><i style="width: {{ ((r.confidence or 0)*100)|round(0,'floor') }}%"></i></div>
            <p class="sx-meta" style="margin-top:8px">
              In <strong>{{ r.box_name }}</strong>
              {% if r.price_cents is not none %} • ${{ '%.2f'|format((r.price_cents or 0)/100) }}{% endif %}
              {% if r.added_at %} • Added {{ r.added_at }}{% endif %}
            </p>
          </div>
        </a>
      {% endfor %}
    {% endif %}
  </section>

  <div id="empty" class="panel sx-empty"><div class="body"><p class="hero__sub" style="margin:0">No matches. Adjust filters or try a different keyword.</p></div></div>

  <div style="display:flex;justify-content:center;margin:16px 0 4px">
    <button id="loadMore" class="sx-btn" type="button" style="display:none">Load more</button>
  </div>

  <!-- Saved searches -->
  <div id="savedWrap" class="sx-panel" style="margin-top:12px;display:none">
    <div class="body">
      <div class="sx-row" style="justify-content:space-between">
        <strong>Saved searches</strong>
        <div>
          <button id="saveSearch" class="sx-btn small" type="button">Save current</button>
          <button id="clearSaved" class="sx-btn small" type="button">Clear</button>
        </div>
      </div>
      <div id="savedChips" class="sx-row" style="margin-top:10px;flex-wrap:wrap"></div>
    </div>
  </div>

</div>

<!-- Modal -->
<div id="sxModal" class="sx-modal" role="dialog" aria-modal="true"><img alt=""></div>

<script>
(() => {
  const $  = (q, c=document)=>c.querySelector(q);
  const $$ = (q, c=document)=>Array.from(c.querySelectorAll(q));

  // Data from server
  const RESULTS = {{ (results_json or [])|tojson }};
  const QUERY   = {{ (q or '')|tojson }};

  // Elements
  const qInput   = $('#q');
  const resultsEl= $('#results');
  const countEl  = $('#sxCount');
  const emptyEl  = $('#empty');
  const sortSel  = $('#sortBy');
  const adv      = $('#adv'), advBtn = $('#toggleAdv');

  const fWithPhoto = $('#fWithPhoto');
  const fPriced    = $('#fPriced');
  const fConf      = $('#fConf');
  const fMin       = $('#fMin');
  const fMax       = $('#fMax');
  const fBox       = $('#fBox');

  const viewGrid = $('#viewGrid');
  const viewList = $('#viewList');
  const exportBtn= $('#exportCsv');
  const loadMore = $('#loadMore');

  const savedWrap= $('#savedWrap');
  const saveBtn  = $('#saveSearch');
  const clearSaved = $('#clearSaved');
  const savedChips = $('#savedChips');

  // State
  let view = localStorage.getItem('inv_view') || 'grid';
  let page = 1, pageSize = 24;   // client-side paging
  let filtered = RESULTS.slice();

  // Helpers
  const fmtPrice = cents => (cents==null) ? '' : `$${(cents/100).toFixed(2)}`;
  const confPct  = v => Math.max(0, Math.min(100, Math.floor((v||0)*100)));
  
  const hasPhoto = r => !!r.image_url;

  function highlight(text, term){
    if(!term) return text;
    try{
      const rx = new RegExp(`(${term.replace(/[.*+?^${}()|[\]\\]/g,'\\$&')})`,'ig');
      return text.replace(rx, '<mark class="sx-hl">$1</mark>');
    }catch{ return text; }
  }

  function uniqueBoxes(){
    return [...new Set(RESULTS.map(r => r.box_name).filter(Boolean))].sort((a,b)=>a.localeCompare(b));
  }

  function applyFilters(){
    const term = (qInput.value || '').trim().toLowerCase();
    const minC = parseFloat(fConf.value||0) || 0;
    const minP = fMin.value ? parseFloat(fMin.value) : null;
    const maxP = fMax.value ? parseFloat(fMax.value) : null;
    const box  = fBox.value || '';

    filtered = RESULTS.filter(r => {
      // text match
      const name = (r.item_name || '').toLowerCase();
      const boxn = (r.box_name || '').toLowerCase();
      const txtOk = !term || name.includes(term) || boxn.includes(term) || (r.added_at||'').toLowerCase().includes(term);
      if(!txtOk) return false;

      // photos
      if (fWithPhoto.checked && !hasPhoto(r)) return false;

      // priced
      if (fPriced.checked && r.price_cents == null) return false;

      // confidence
      if ((r.confidence || 0) < minC) return false;

      // price range
      if (minP != null && (r.price_cents == null || (r.price_cents/100) < minP)) return false;
      if (maxP != null && (r.price_cents == null || (r.price_cents/100) > maxP)) return false;

      // box
      if (box && r.box_name !== box) return false;

      return true;
    });

    applySort(true);
    page = 1;
    render();
  }

  function applySort(skipRender){
    const mode = sortSel.value;
    filtered.sort((a,b)=>{
      switch(mode){
        case 'name_asc':  return (a.item_name||'').localeCompare(b.item_name||'');
        case 'name_desc': return (b.item_name||'').localeCompare(a.item_name||'');
        case 'price_asc': return (a.price_cents??Infinity) - (b.price_cents??Infinity);
        case 'price_desc':return (b.price_cents??-Infinity) - (a.price_cents??-Infinity);
        case 'conf_desc': return (b.confidence||0) - (a.confidence||0);
        case 'conf_asc':  return (a.confidence||0) - (b.confidence||0);
        case 'date_asc':  return (a.added_at||'').localeCompare(b.added_at||'');
        case 'date_desc': return (b.added_at||'').localeCompare(a.added_at||'');
        case 'relevance':
        default:
          // lightweight: prioritize term presence + confidence + recent
          const term = (qInput.value||'').trim().toLowerCase();
          const score = (r)=>{
            let s = 0;
            if(term){
              const inName = (r.item_name||'').toLowerCase().includes(term);
              const inBox  = (r.box_name||'').toLowerCase().includes(term);
              if(inName) s += 30;
              if(inBox)  s += 10;
            }
            s += Math.round((r.confidence||0)*50);
            s += ((r.price_cents!=null)?5:0);
            s += ((r.added_at||'').slice(0,10).replaceAll('-','')|0) / 1e8; // tiny recency nudge
            return s;
          };
          return score(b) - score(a);
      }
    });
    if(!skipRender) render();
  }

  function asCard(r, term){
    const href = {{ "url_for('boxes.box_detail', box_id='__ID__')"|tojson }}.replace('__ID__', r.box_id);
    const img  = r.image_url || `https://source.unsplash.com/1200x675/?${encodeURIComponent(r.item_name||'object')},object`;
    return `
      <a class="sx-card sx-col" href="${href}" data-focusable>
        <figure class="sx-media">
          <img src="${img}" alt="${(r.item_name||'Item').replace(/"/g,'&quot;')}" loading="lazy" decoding="async" data-zoom>
        </figure>
        <div class="sx-pad">
          <div class="sx-row-between" style="margin-bottom:6px">
            <h3 class="sx-title-sm">${highlight(r.item_name||'Untitled', term)}</h3>
            <span class="chip">Conf ${(r.confidence??0).toFixed(2)}</span>
          </div>
          <div class="sx-progress" aria-hidden="true"><i style="width:${confPct(r.confidence)}%"></i></div>
          <p class="sx-meta" style="margin-top:8px">
            In <strong>${highlight(r.box_name||'—', term)}</strong>
            ${r.price_cents!=null?` • ${fmtPrice(r.price_cents)}`:''}
            ${r.added_at?` • Added ${r.added_at}`:''}
          </p>
        </div>
      </a>`;
  }

  function render(){
    const term = (qInput.value||'').trim();
    const total = filtered.length;
    countEl.textContent = `${total} result${total===1?'':'s'}`;

    if(!total){
      resultsEl.innerHTML = '';
      emptyEl.classList.add('show');
      loadMore.style.display = 'none';
      return;
    }
    emptyEl.classList.remove('show');

    const end = Math.min(total, page*pageSize);
    const pageSlice = filtered.slice(0, end);
    resultsEl.innerHTML = pageSlice.map(r => asCard(r, term)).join('');

    loadMore.style.display = end < total ? 'inline-flex' : 'none';

    // focus ring navigation
    // currentIndex = 0;
    // focusItem(0);
  }
  
  // View toggle
  function setView(v){
    view = v; localStorage.setItem('inv_view', v);
    resultsEl.classList.toggle('sx-list', v==='list');
    viewGrid.setAttribute('aria-pressed', String(v==='grid'));
    viewList.setAttribute('aria-pressed', String(v==='list'));
  }

  // Debounce
  function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

  // Saved searches (localStorage)
  function loadSaved(){
    const arr = JSON.parse(localStorage.getItem('inv_saved') || '[]');
    savedWrap.style.display = arr.length ? 'block' : 'none';
    savedChips.innerHTML = arr.map((s,i)=>`<button class="sx-btn small" data-load="${i}" type="button">${s.q}</button>`).join('');
  }
  function saveCurrent(){
    const data = {
      q: qInput.value || '',
      withPhoto: fWithPhoto.checked,
      priced: fPriced.checked,
      conf: fConf.value,
      min: fMin.value,
      max: fMax.value,
      box: fBox.value,
      sort: sortSel.value,
      view
    };
    const arr = JSON.parse(localStorage.getItem('inv_saved') || '[]');
    arr.unshift(data); localStorage.setItem('inv_saved', JSON.stringify(arr.slice(0,20)));
    loadSaved();
  }
  function applySaved(s){
    qInput.value = s.q||'';
    fWithPhoto.checked = !!s.withPhoto;
    fPriced.checked = !!s.priced;
    fConf.value = s.conf||0;
    fMin.value = s.min||'';
    fMax.value = s.max||'';
    fBox.value = s.box||'';
    sortSel.value = s.sort||'relevance';
    setView(s.view || 'grid');
    applyFilters();
  }

  // CSV export of current filtered slice
  function exportCSV(){
    const header = ['item_name','box_id','box_name','price','confidence','added_at','image_url'];
    const rows = filtered.map(r=>[
      (r.item_name||'').replaceAll('"','""'),
      r.box_id,
      (r.box_name||'').replaceAll('"','""'),
      r.price_cents!=null?(r.price_cents/100).toFixed(2):'',
      (r.confidence??0).toFixed(2),
      r.added_at||'',
      r.image_url||''
    ]);
    const csv = [header.join(','), ...rows.map(r=>r.map(x=>`"${x}"`).join(','))].join('\n');
    const blob = new Blob([csv], {type:'text/csv'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `inventoryiq-search-${Date.now()}.csv`;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // Keyboard: focus search with /
  window.addEventListener('keydown', (e)=>{
    const tag=(document.activeElement||{}).tagName;
    if (e.key==='/' && tag!=='INPUT' && tag!=='TEXTAREA') { e.preventDefault(); qInput.focus(); qInput.select(); }
  });

  // Arrow-key nav between results, Enter to open
  let currentIndex = 0;
  function focusItem(i){
    const items = $$('[data-focusable]', resultsEl);
    if(!items.length) return;
    currentIndex = (i+items.length)%items.length;
    items[currentIndex].focus({preventScroll:true});
  }

  qInput.addEventListener('keydown', (e) => {
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    focusItem(0);
  }
});
  resultsEl.addEventListener('keydown', (e)=>{
    if(e.key==='ArrowDown'){ e.preventDefault(); focusItem(currentIndex+1); }
    if(e.key==='ArrowUp'){ e.preventDefault(); focusItem(currentIndex-1); }
  });

  // Lightbox
  const modal = $('#sxModal'); const modalImg = modal.querySelector('img');
  function openModal(src){ modalImg.src=src; modal.classList.add('is-open'); }
  function closeModal(){ modal.classList.remove('is-open'); }
  document.addEventListener('click', (e)=>{
    const z = e.target.closest('[data-zoom]'); if(z){ e.preventDefault(); openModal(z.src); }
    if(e.target===modal) closeModal();
  });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  // Events
  advBtn.addEventListener('click', ()=>{ const open = adv.classList.toggle('show'); advBtn.setAttribute('aria-expanded', String(open)); });
  [qInput,fWithPhoto,fPriced,fConf,fMin,fMax,fBox].forEach(el=> el && el.addEventListener('input', debounce(applyFilters, 120)));
  sortSel.addEventListener('change', ()=> applySort());
  viewGrid.addEventListener('click', ()=> setView('grid'));
  viewList.addEventListener('click', ()=> setView('list'));
  exportBtn.addEventListener('click', exportCSV);

  loadMore.addEventListener('click', ()=>{ page++; render(); });

  saveBtn.addEventListener('click', saveCurrent);
  clearSaved.addEventListener('click', ()=>{ localStorage.removeItem('inv_saved'); loadSaved(); });
  savedChips.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-load]'); if(!btn) return;
    const arr = JSON.parse(localStorage.getItem('inv_saved')||'[]');
    const obj = arr[parseInt(btn.dataset.load,10)]; if(obj) applySaved(obj);
  });

  // Init
  // Populate box dropdown from RESULTS (unique) if SSR fallback missed some
  const optSet = new Set([...$$('#fBox option')].map(o=>o.value));
  uniqueBoxes().forEach(b=>{ if(!optSet.has(b)){ const o=document.createElement('option'); o.value=o.textContent=b; fBox.appendChild(o); }});

  if(QUERY) qInput.value = QUERY;
  setView(view);
  applyFilters();
  loadSaved();
})();
</script>
{% endblock %}
